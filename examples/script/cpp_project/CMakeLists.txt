cmake_minimum_required(VERSION 3.14)
project(script_guest_cpp VERSION 1.0.0 LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# LoongArch cross-compilation settings
set(CMAKE_SYSTEM_NAME Linux)
set(CMAKE_SYSTEM_PROCESSOR loongarch64)
set(CMAKE_C_COMPILER loongarch64-linux-gnu-gcc-14)
set(CMAKE_CXX_COMPILER loongarch64-linux-gnu-g++-14)

# Required linker flags for libloong compatibility
set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -static -Wl,-Ttext-segment=0x200000")

# Generate API bindings before build
# This requires the host application to have registered bindings first
# In practice, this happens via a tool that runs the host with --generate-bindings
add_custom_command(
    OUTPUT ${CMAKE_CURRENT_SOURCE_DIR}/libloong_api.hpp
    COMMAND echo "// API bindings generated externally" > ${CMAKE_CURRENT_SOURCE_DIR}/libloong_api.hpp
    COMMENT "API bindings placeholder (generated by host application)"
)

# Guest executable
add_executable(guest_app
    src/main.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/libloong_api.hpp
)

target_include_directories(guest_app PRIVATE ${CMAKE_CURRENT_SOURCE_DIR})

# Install target
install(TARGETS guest_app DESTINATION bin)
